<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title>Multibyte Encoding Support in Nvi</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="multibyte-encoding-support-in-nvi">
<h1 class="title">Multibyte Encoding Support in Nvi</h1>

<div class="section" id="abstract">
<h1>Abstract</h1>
<p><em>Nvi</em> is a BSD-licensed re-implementation of the original vi editor. While most of the userland tools in the FreeBSD base system support multibyte encodings <a class="footnote-reference" href="#id5" id="id1">[1]</a>, there is no nvi fork comes with sufficient multibyte encoding (both Unicode and non-Unicode) support so far. My GSoC2011 proposal aims to add the complete iconv-based multibyte encoding support to nvi.</p>
</div>
<div class="section" id="about-me">
<h1>About me</h1>
<p>I am Zhihao Yuan, a junior student majoring in Computer Science in the Northern Illinois University. I use <cite>lichray</cite> as my ID on the Internet.</p>
<p>I have been using FreeBSD for five years, and I started to submit PR two months ago. The reason that I contribute to FreeBSD is <cite>miwi&#64;</cite>'s &quot;call&quot;<a class="footnote-reference" href="#id6" id="id2">[2]</a>. The ATI and Xfce update problems referred by his article are found and solved by me. Currently, I only maintain 2 ports, but I have about 10 ports to be committed (some of them were sent to the committers directly).</p>
<p>Nvi is written in C, and relies on ncurses; this project will add the iconv support to nvi. I program in C with vim since 2004, and I am familiar with the UNIX system programming. I got two A's for both of my UNIX and Operating System Principles courses. However, I did not use libiconv in the projects I participated before. But as a Chinese user, I do have sufficient knowledge and experience with character sets, encodings, and even endianness. So basically, to complete this project, I need to learn the <cite>libiconv</cite> and some <cite>ncurses</cite> programming.</p>
<div class="section" id="availability">
<h2>Availability</h2>
<p>I have a full-time job in this summer (at Fermilab), but I still want to participate in GSoC, since I am sure I have the ability to handle both. I can work for 10 to 15 hours a week on this project, from 05/16 to 08/12. There is no vacation planned during the summer.</p>
</div>
</div>
<div class="section" id="project-description">
<h1>Project Description</h1>
<p>This project aims to add the complete iconv-based multibyte encoding support to nvi.</p>
<div class="section" id="background">
<h2>Background</h2>
<p>Multibyte encodings are character encodings that use more than one byte to represent a character in the languages. However, when we refer &quot;multibyte&quot; in this article, we mean both single C chars character sets and the wide encodings <a class="footnote-reference" href="#id7" id="id3">[3]</a>. The former one can be either ASCII or 8-bit extended encodings, e.g., ISO8859-15, KOI8-R; the latter one can be either non-Unicode encodings, e.g., GBK, SJIS, or Unicode families.</p>
<p>A program that &quot;fully supports multibyte encodings&quot; should be able to read/write/display a text file with any encodings supported by libiconv, as them listed by the command <tt class="docutils literal">iconv <span class="pre">-l</span></tt>.</p>
</div>
<div class="section" id="requirements">
<h2>Requirements</h2>
<p>The following requirements for the new nvi should be met when the project is finished:</p>
<ol class="arabic simple">
<li>It fully supports multibyte encodings with libiconv, and it can be compiled and run if libiconv is unavailable or disabled.</li>
<li>Its encoding settings can be changed though ex commands at the runtime. By default, it obeys the LC_CTYPE setting. The file encoding detection feature needs further discussion.</li>
<li>It behaviors in the original nvi <cite>1.79</cite> way. Features that do not relate to editing might be improved.</li>
<li>It can be qualified to enter the FreeBSD base system. The code obeys <a class="reference external" href="http://www.freebsd.org/cgi/man.cgi?query=style">style(9)</a>, and the whole software is distributed under a BSD-style license.</li>
</ol>
</div>
<div class="section" id="existing-solutions">
<h2>Existing Solutions</h2>
<p>There are several vi/nvi forks that support multibyte encodings:</p>
<ol class="arabic simple">
<li>nvi-m17n, as editor/nvi-m17n in the ports. It's a multilingual patch to nvi <cite>1.79</cite>, which is the nvi in the nowadays FreeBSD base system. It only supports ISO-8859 families and non-Unicode CJK encodings.</li>
<li>nvi-1.85, as editor/nvi-devel in the ports. It's included in the NetBSD base system. This version does not support non-Unicode encodings. And it depends on DB3/4, which makes it impossible for FreeBSD to accept it. In addition, it was reported that it behaviors differently from the traditional vi/nvi.</li>
<li>ex-vi, as editor/2bsd-vi in the ports. It's a BSD-licensed, enhanced version of the original vi in SysV <a class="footnote-reference" href="#id8" id="id4">[4]</a>. It supports Unicode and non-Unicode encodings (in a personal rough test). However, as a &quot;traditional vi&quot;, it lacks of some nvi-specific features, including infinite undo, multiple buffer, and multiple window, etc. To keep the current user experiences, we have strong reason to keep using nvi.</li>
<li>Other non-compatible forks, such as vim and elvis. We can safely ignore them when talking about the vi in the base system.</li>
</ol>
<p>As an initial plan, I can start from nvi's code, analyze nvi-1.85's libiconv usage, study nvi-m17n's encoding detection and encoding switch, then create a new multibyte solution for nvi.</p>
</div>
<div class="section" id="testing-plan">
<h2>Testing Plan</h2>
<p>The testing will cover at least the following three parts:</p>
<ol class="arabic simple">
<li>Wide character display and editing. The new vi program should be able to display and edit wide characters (ncurses functionality, to be more specific). These tests need to be done manually.</li>
<li>Multibyte text processing. The new ex command should be able to match/substitute multibyte text. These tests will use vim as a reference and can be automated with scripts.</li>
<li>Portability. The whole software must be able to be built and to run on the FreeBSD branches from RELENG_7 to CURRENT. These tests can be done by hand in <a class="reference external" href="http://www.freebsd.org/cgi/man.cgi?query=jail">jail(8)</a>.</li>
</ol>
</div>
<div class="section" id="schedule">
<h2>Schedule</h2>
<blockquote>
<cite>* This schedule requires further discussion with my mentor.</cite></blockquote>
<ol class="arabic simple">
<li><em>5/16-5/27</em> Read and clean up the nvi-1.79 code. Remove perl and tcl bindings if possible.</li>
<li><em>5/30-6/03</em> Construct the <tt class="docutils literal">wchar_t</tt> and libncursesw framework. Then nvi should work with the raw multibyte data instead of print escaped bytes.</li>
<li><em>6/06-6/17</em> Introduce the libiconv support and the basic LC_CTYPE detection. Then nvi should be able to read/write locale-limited text.</li>
<li><em>6/20-6/24</em> Run all tests. Prepare a phase report if needed.</li>
<li><em>6/27-7/08</em> Design and implement the new encoding-related <cite>ex</cite> commands.</li>
<li><em>7/11-7/15</em> Execute the complete testing plan. Now nvi should be able to handle all encodings listed in <tt class="docutils literal">iconv <span class="pre">-l</span></tt>.</li>
<li><em>7/18-7/29</em> Port and extend nvi-m17n's file encoding detection infrastructure.</li>
<li><em>8/01-8/05</em> Rerun the portability testing. Prepare the final report.</li>
<li><em>8/08-8/12</em> Last week. Call for tests in the community.</li>
</ol>
</div>
</div>
<div class="section" id="references">
<h1>References</h1>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Oldroyd, J.R. (2009, April 11). <cite>Unicode Support on FreeBSD</cite>, from <a class="reference external" href="http://opal.com/jr/freebsd/unicode/#textutils2">http://opal.com/jr/freebsd/unicode/#textutils2</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Wilke, M. (2011, March 6). <cite>FreeBSD needs fresh Blood!</cite>, from <a class="reference external" href="http://miwi.bsdcrew.de/2011/03/freebsd-needs-fresh-blood/">http://miwi.bsdcrew.de/2011/03/freebsd-needs-fresh-blood/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Wu, M.C. (2010). Localization - I18N/L10N Usage and Setup. In <cite>FreeBSD Handbook</cite>, <a class="reference external" href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/using-localization.html">http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/using-localization.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Ritter, G. (2007, November 29). <cite>The Traditional Vi</cite>, at <a class="reference external" href="http://ex-vi.sourceforge.net/">http://ex-vi.sourceforge.net/</a></td></tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Zhihao Yuan &lt;<a class="reference external" href="mailto:lichray&#64;gmail.com">lichray&#64;gmail.com</a>&gt;</td>
</tr>
<tr class="field"><th class="field-name">Date:</th><td class="field-body">2011-04-03</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="footer">
<hr class="footer" />
Generated on: 2011-04-03.

</div>
</body>
</html>
